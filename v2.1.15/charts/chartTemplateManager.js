"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();define(["jquery","charts/chartWindow","common/rivetsExtra"],function(a,b,c){require(["text!charts/chartTemplateManager.html"]),local_storage.get("templates")||local_storage.set("templates",[]);var d=function(){function d(a,b){var e=this;_classCallCheck(this,d);var f=this.init_state(a,b);require(["text!charts/chartTemplateManager.html"],function(b){a.append(b.i18n()),e.view=c.bind(a[0],f)})}return _createClass(d,[{key:"init_state",value:function(d,e){var f=(a("#"+e+"_chart").highcharts(),{route:{value:"menu"},menu:{save_changes_disabled:!0},templates:{array:local_storage.get("templates"),save_as_value:"",rename_tmpl:null,rename_value:"",current:null}}),g=f.route,h=f.templates,i=f.menu,j=b.get_chart_options(e);-1!==_.findIndex(h.array,function(a){return a.name===j.name})&&(h.current=j),g.update=function(a){g.value=a},i.save_as=function(){var a=b.get_chart_options(e)||{};a.name=[a.timePeriod+" "+a.type].concat(a.indicators.map(function(a){return a.name})).concat(a.overlays.map(function(a){return a.displaySymbol})).join(" + "),h.save_as_value=a.name.substring(0,20),g.update("save-as")},i.templates=function(){h.array=local_storage.get("templates"),g.update("templates")},i.save_changes=function(){var c=b.get_chart_options(e),d=c.name,f=local_storage.get("templates"),g=_.findIndex(f,function(a){return a.name===d});-1!==g?f[g]=c:f.push(c),local_storage.set("templates",f),h.array=f,h.current=c,a.growl.notice({message:a("<div/>").text("Template changes saved ".i18n()+"("+c.name+")").html()})},i.open_file_selector=function(b){a(b.target).next().click()},i.upload=function(b){var c=b.target.files[0];if(c){var d=new FileReader;d.onload=function(b){var c=b.target.result,d=null;try{d=JSON.parse(c);var e=d.random;if(delete d.random,e!==k(JSON.stringify(d)))throw new UserException("InvalidHash")}catch(b){return void a.growl.error({message:"Invalid json file."})}h.apply(d);for(var f=local_storage.get("templates"),g=!1,i=1,j=d.name;!g;)f.map(function(a){return a.name}).includes(j)?(j=d.name+" ("+i+")",i++):(d.name=j,g=!0);f.push(d),local_storage.set("templates",f),h.array=f,a.growl.notice({message:"Successfully applied the template and saved it as ".i18n()+"<b>"+d.name+"</b>"})},d.readAsText(c)}},h.save_as=function(c){c.preventDefault();var d=h.save_as_value.substring(0,20),f=b.get_chart_options(e);if(f){f.name=d;var i=local_storage.get("templates");if(i.map(function(a){return a.name}).includes(d))return void a.growl.error({message:"Template name already exists".i18n()});i.push(f),h.current=f,local_storage.set("templates",i),h.array=i,g.update("menu"),b.set_chart_options(e,f)}},h.download=function(b){a.growl.notice({message:"Downloading template as <b>".i18n()+b.name+".json</b>"})},h.remove=function(a){var b=local_storage.get("templates");h.array=b.filter(function(b){return b.name!==a.name}),local_storage.set("templates",h.array),h.current&&a.name===h.current.name&&(h.current=null)},h.rename=function(a){h.rename_value=a.name,h.rename_tmpl=a,g.update("rename")},h.do_rename=function(c){c.preventDefault();var d=h.rename_tmpl.name,f=h.rename_value.substring(0,20),i=local_storage.get("templates");if(i.map(function(a){return a.name}).includes(f))return void a.growl.error({message:"Template name already exists".i18n()});var j=i.find(function(a){return a.name===d});if(j){j.name=f,local_storage.set("templates",i),h.array=i,g.update("templates");var k=b.get_chart_options(e);k.name==d&&(h.current=k,k.name=f,b.set_chart_options(e,k))}},h.apply=function(a){b.apply_chart_options(e,a),h.current=a},h.confirm=function(a,b){g.update("confirm");var c=b.currentTarget.text;h.confirm_prevMenu=c==="Delete".i18n()?"templates":"menu",h.confirm_text="Delete"===c?"Are you sure you want to delete template?".i18n():"Are you sure you want to overwrite current template?".i18n(),h.confirm_yes=function(){c==="Delete".i18n()?h.remove(a):i.save_changes(),h.confirm_no()},h.confirm_no=function(){g.update(h.confirm_prevMenu)}};var k=function(a){return a.split("").reduce(function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0)};return c.binders.download=function(b,c){c.random=k(JSON.stringify(c));var d="data:text/plain;charset=utf-8,"+encodeURIComponent(JSON.stringify(c));a(b).attr("href",d),a(b).attr("download",c.name+".json")},f}},{key:"unbind",value:function(){this.view&&this.view.unbind(),this.view=null}}]),d}();return{init:function(a,b){return new d(a,b)}}});